"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _JwtGenerator = _interopRequireDefault(require("./JwtGenerator"));

var _HashGenerator = _interopRequireDefault(require("./HashGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Right now only key/secret credentials are supported.
 * However, in time JWT will also be supported.
 * The `Credentials` object provides an abstraction to this.
 *
 * @param {string} apiKey - A Vonage API Key
 * @param {string} apiSecret - A Vonage API Secret
 * @param {string} [applicationId] - A VonageApplication ID
 * @param {string|Buffer} [privateKey] -  When a string value is passed it should
 *                        either represent the path to the private key, or the actual
 *                        private key in string format. If a Buffer is passed then
 *                        it should be the key read from the file system.
 * @param {string} [signatureSecret] - A Vonage signature Secret
 * @param {string} [signatureMethod] - A Vonage compatible request signing method
 */
class Credentials {
  constructor(apiKey, apiSecret, privateKey, applicationId, signatureSecret, signatureMethod) {
    this.apiKey = apiKey;
    this.apiSecret = apiSecret;
    this.privateKey = null;
    this.applicationId = applicationId;
    this.signatureSecret = signatureSecret;
    this.signatureMethod = signatureMethod;

    if (privateKey instanceof Buffer) {
      // it is already a buffer, use it as-is
      this.privateKey = privateKey;
    } else if (typeof privateKey === "string" && privateKey.startsWith("-----BEGIN PRIVATE KEY-----")) {
      // It's a key string. Check for \n, replace with newlines
      privateKey = privateKey.replace(/\\n/g, "\n");
      this.privateKey = Buffer.from(privateKey, "utf-8");
    } else if (privateKey !== undefined) {
      if (!_fs.default.existsSync(privateKey)) {
        throw new Error("File \"".concat(privateKey, "\" not found."));
      }

      this.privateKey = _fs.default.readFileSync(privateKey);
    }
    /** @private */


    this._jwtGenerator = new _JwtGenerator.default();
    this._hashGenerator = new _HashGenerator.default();
  }
  /**
   * Generate a Jwt using the Private Key in the Credentials.
   * By default the credentials.applicationId will be used when creating the token.
   * However, this can be overwritten.
   *
   * @param {string} [applicationId] an application ID to be used instead of the
   *                default Credentials.applicationId value.
   *
   * @returns {string} The generated JWT
   */


  generateJwt() {
    var applicationId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.applicationId;
    var privateKey = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.privateKey;
    var claims = {
      application_id: applicationId
    };

    var token = this._jwtGenerator.generate(privateKey, claims);

    return token;
  }

  generateSignature(params) {
    var signatureSecret = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.signatureSecret;
    var signatureMethod = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.signatureMethod;
    return this._hashGenerator.generate(signatureMethod, signatureSecret, params);
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setJwtGenerator(generator) {
    this._jwtGenerator = generator;
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setHashGenerator(generator) {
    this._hashGenerator = generator;
  }
  /**
   * Ensures a credentials instance is used.
   *
   * Key/Secret credentials are only supported at present.
   */


  static parse(obj) {
    if (obj instanceof Credentials) {
      return obj;
    } else {
      return new Credentials(obj.apiKey, obj.apiSecret, obj.privateKey, obj.applicationId, obj.signatureSecret, obj.signatureMethod);
    }
  }

}

var _default = Credentials;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDcmVkZW50aWFscyIsImNvbnN0cnVjdG9yIiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwicHJpdmF0ZUtleSIsImFwcGxpY2F0aW9uSWQiLCJzaWduYXR1cmVTZWNyZXQiLCJzaWduYXR1cmVNZXRob2QiLCJCdWZmZXIiLCJzdGFydHNXaXRoIiwicmVwbGFjZSIsImZyb20iLCJ1bmRlZmluZWQiLCJmcyIsImV4aXN0c1N5bmMiLCJFcnJvciIsInJlYWRGaWxlU3luYyIsIl9qd3RHZW5lcmF0b3IiLCJKd3RHZW5lcmF0b3IiLCJfaGFzaEdlbmVyYXRvciIsIkhhc2hHZW5lcmF0b3IiLCJnZW5lcmF0ZUp3dCIsImNsYWltcyIsImFwcGxpY2F0aW9uX2lkIiwidG9rZW4iLCJnZW5lcmF0ZSIsImdlbmVyYXRlU2lnbmF0dXJlIiwicGFyYW1zIiwiX3NldEp3dEdlbmVyYXRvciIsImdlbmVyYXRvciIsIl9zZXRIYXNoR2VuZXJhdG9yIiwicGFyc2UiLCJvYmoiXSwic291cmNlcyI6WyIuLi9zcmMvQ3JlZGVudGlhbHMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCBKd3RHZW5lcmF0b3IgZnJvbSBcIi4vSnd0R2VuZXJhdG9yXCI7XG5pbXBvcnQgSGFzaEdlbmVyYXRvciBmcm9tIFwiLi9IYXNoR2VuZXJhdG9yXCI7XG5cbi8qKlxuICogUmlnaHQgbm93IG9ubHkga2V5L3NlY3JldCBjcmVkZW50aWFscyBhcmUgc3VwcG9ydGVkLlxuICogSG93ZXZlciwgaW4gdGltZSBKV1Qgd2lsbCBhbHNvIGJlIHN1cHBvcnRlZC5cbiAqIFRoZSBgQ3JlZGVudGlhbHNgIG9iamVjdCBwcm92aWRlcyBhbiBhYnN0cmFjdGlvbiB0byB0aGlzLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGlLZXkgLSBBIFZvbmFnZSBBUEkgS2V5XG4gKiBAcGFyYW0ge3N0cmluZ30gYXBpU2VjcmV0IC0gQSBWb25hZ2UgQVBJIFNlY3JldFxuICogQHBhcmFtIHtzdHJpbmd9IFthcHBsaWNhdGlvbklkXSAtIEEgVm9uYWdlQXBwbGljYXRpb24gSURcbiAqIEBwYXJhbSB7c3RyaW5nfEJ1ZmZlcn0gW3ByaXZhdGVLZXldIC0gIFdoZW4gYSBzdHJpbmcgdmFsdWUgaXMgcGFzc2VkIGl0IHNob3VsZFxuICogICAgICAgICAgICAgICAgICAgICAgICBlaXRoZXIgcmVwcmVzZW50IHRoZSBwYXRoIHRvIHRoZSBwcml2YXRlIGtleSwgb3IgdGhlIGFjdHVhbFxuICogICAgICAgICAgICAgICAgICAgICAgICBwcml2YXRlIGtleSBpbiBzdHJpbmcgZm9ybWF0LiBJZiBhIEJ1ZmZlciBpcyBwYXNzZWQgdGhlblxuICogICAgICAgICAgICAgICAgICAgICAgICBpdCBzaG91bGQgYmUgdGhlIGtleSByZWFkIGZyb20gdGhlIGZpbGUgc3lzdGVtLlxuICogQHBhcmFtIHtzdHJpbmd9IFtzaWduYXR1cmVTZWNyZXRdIC0gQSBWb25hZ2Ugc2lnbmF0dXJlIFNlY3JldFxuICogQHBhcmFtIHtzdHJpbmd9IFtzaWduYXR1cmVNZXRob2RdIC0gQSBWb25hZ2UgY29tcGF0aWJsZSByZXF1ZXN0IHNpZ25pbmcgbWV0aG9kXG4gKi9cbmNsYXNzIENyZWRlbnRpYWxzIHtcbiAgY29uc3RydWN0b3IoXG4gICAgYXBpS2V5LFxuICAgIGFwaVNlY3JldCxcbiAgICBwcml2YXRlS2V5LFxuICAgIGFwcGxpY2F0aW9uSWQsXG4gICAgc2lnbmF0dXJlU2VjcmV0LFxuICAgIHNpZ25hdHVyZU1ldGhvZFxuICApIHtcbiAgICB0aGlzLmFwaUtleSA9IGFwaUtleTtcbiAgICB0aGlzLmFwaVNlY3JldCA9IGFwaVNlY3JldDtcblxuICAgIHRoaXMucHJpdmF0ZUtleSA9IG51bGw7XG4gICAgdGhpcy5hcHBsaWNhdGlvbklkID0gYXBwbGljYXRpb25JZDtcblxuICAgIHRoaXMuc2lnbmF0dXJlU2VjcmV0ID0gc2lnbmF0dXJlU2VjcmV0O1xuICAgIHRoaXMuc2lnbmF0dXJlTWV0aG9kID0gc2lnbmF0dXJlTWV0aG9kO1xuXG4gICAgaWYgKHByaXZhdGVLZXkgaW5zdGFuY2VvZiBCdWZmZXIpIHtcbiAgICAgIC8vIGl0IGlzIGFscmVhZHkgYSBidWZmZXIsIHVzZSBpdCBhcy1pc1xuICAgICAgdGhpcy5wcml2YXRlS2V5ID0gcHJpdmF0ZUtleTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgdHlwZW9mIHByaXZhdGVLZXkgPT09IFwic3RyaW5nXCIgJiZcbiAgICAgIHByaXZhdGVLZXkuc3RhcnRzV2l0aChcIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVwiKVxuICAgICkge1xuICAgICAgLy8gSXQncyBhIGtleSBzdHJpbmcuIENoZWNrIGZvciBcXG4sIHJlcGxhY2Ugd2l0aCBuZXdsaW5lc1xuICAgICAgcHJpdmF0ZUtleSA9IHByaXZhdGVLZXkucmVwbGFjZSgvXFxcXG4vZywgXCJcXG5cIik7XG4gICAgICB0aGlzLnByaXZhdGVLZXkgPSBCdWZmZXIuZnJvbShwcml2YXRlS2V5LCBcInV0Zi04XCIpO1xuICAgIH0gZWxzZSBpZiAocHJpdmF0ZUtleSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmMocHJpdmF0ZUtleSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlIFwiJHtwcml2YXRlS2V5fVwiIG5vdCBmb3VuZC5gKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucHJpdmF0ZUtleSA9IGZzLnJlYWRGaWxlU3luYyhwcml2YXRlS2V5KTtcbiAgICB9XG5cbiAgICAvKiogQHByaXZhdGUgKi9cbiAgICB0aGlzLl9qd3RHZW5lcmF0b3IgPSBuZXcgSnd0R2VuZXJhdG9yKCk7XG4gICAgdGhpcy5faGFzaEdlbmVyYXRvciA9IG5ldyBIYXNoR2VuZXJhdG9yKCk7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgYSBKd3QgdXNpbmcgdGhlIFByaXZhdGUgS2V5IGluIHRoZSBDcmVkZW50aWFscy5cbiAgICogQnkgZGVmYXVsdCB0aGUgY3JlZGVudGlhbHMuYXBwbGljYXRpb25JZCB3aWxsIGJlIHVzZWQgd2hlbiBjcmVhdGluZyB0aGUgdG9rZW4uXG4gICAqIEhvd2V2ZXIsIHRoaXMgY2FuIGJlIG92ZXJ3cml0dGVuLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gW2FwcGxpY2F0aW9uSWRdIGFuIGFwcGxpY2F0aW9uIElEIHRvIGJlIHVzZWQgaW5zdGVhZCBvZiB0aGVcbiAgICogICAgICAgICAgICAgICAgZGVmYXVsdCBDcmVkZW50aWFscy5hcHBsaWNhdGlvbklkIHZhbHVlLlxuICAgKlxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZ2VuZXJhdGVkIEpXVFxuICAgKi9cbiAgZ2VuZXJhdGVKd3QoXG4gICAgYXBwbGljYXRpb25JZCA9IHRoaXMuYXBwbGljYXRpb25JZCxcbiAgICBwcml2YXRlS2V5ID0gdGhpcy5wcml2YXRlS2V5XG4gICkge1xuICAgIHZhciBjbGFpbXMgPSB7XG4gICAgICBhcHBsaWNhdGlvbl9pZDogYXBwbGljYXRpb25JZCxcbiAgICB9O1xuICAgIHZhciB0b2tlbiA9IHRoaXMuX2p3dEdlbmVyYXRvci5nZW5lcmF0ZShwcml2YXRlS2V5LCBjbGFpbXMpO1xuICAgIHJldHVybiB0b2tlbjtcbiAgfVxuXG4gIGdlbmVyYXRlU2lnbmF0dXJlKFxuICAgIHBhcmFtcyxcbiAgICBzaWduYXR1cmVTZWNyZXQgPSB0aGlzLnNpZ25hdHVyZVNlY3JldCxcbiAgICBzaWduYXR1cmVNZXRob2QgPSB0aGlzLnNpZ25hdHVyZU1ldGhvZFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5faGFzaEdlbmVyYXRvci5nZW5lcmF0ZShcbiAgICAgIHNpZ25hdHVyZU1ldGhvZCxcbiAgICAgIHNpZ25hdHVyZVNlY3JldCxcbiAgICAgIHBhcmFtc1xuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogVXNlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5LlxuICAgKi9cbiAgX3NldEp3dEdlbmVyYXRvcihnZW5lcmF0b3IpIHtcbiAgICB0aGlzLl9qd3RHZW5lcmF0b3IgPSBnZW5lcmF0b3I7XG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogVXNlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5LlxuICAgKi9cbiAgX3NldEhhc2hHZW5lcmF0b3IoZ2VuZXJhdG9yKSB7XG4gICAgdGhpcy5faGFzaEdlbmVyYXRvciA9IGdlbmVyYXRvcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbnN1cmVzIGEgY3JlZGVudGlhbHMgaW5zdGFuY2UgaXMgdXNlZC5cbiAgICpcbiAgICogS2V5L1NlY3JldCBjcmVkZW50aWFscyBhcmUgb25seSBzdXBwb3J0ZWQgYXQgcHJlc2VudC5cbiAgICovXG4gIHN0YXRpYyBwYXJzZShvYmopIHtcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgQ3JlZGVudGlhbHMpIHtcbiAgICAgIHJldHVybiBvYmo7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBuZXcgQ3JlZGVudGlhbHMoXG4gICAgICAgIG9iai5hcGlLZXksXG4gICAgICAgIG9iai5hcGlTZWNyZXQsXG4gICAgICAgIG9iai5wcml2YXRlS2V5LFxuICAgICAgICBvYmouYXBwbGljYXRpb25JZCxcbiAgICAgICAgb2JqLnNpZ25hdHVyZVNlY3JldCxcbiAgICAgICAgb2JqLnNpZ25hdHVyZU1ldGhvZFxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ3JlZGVudGlhbHM7XG4iXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUFNQSxXQUFOLENBQWtCO0VBQ2hCQyxXQUFXLENBQ1RDLE1BRFMsRUFFVEMsU0FGUyxFQUdUQyxVQUhTLEVBSVRDLGFBSlMsRUFLVEMsZUFMUyxFQU1UQyxl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